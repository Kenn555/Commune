{% extends "action_base.html" %}
{% block action %}
{% load i18n %}
{% translate "Other Informations" as parents_information %}
{% translate 'Matricule' as matricule %}
{% translate 'Declarer' as declarer %}

  <style>
    div > label {
      font-weight: 600;
      font-family: sans-serif;
    }
  </style>
   <style>
        /* Styles personnalisés pour Select2 */
        .select2-container {
            min-width: 100% !important;
        }
        
        .select2-container--default .select2-selection--single {
            background-color: transparent;
            border: none;
            border-bottom: 2px solid #d1d5db;
            border-radius: 0;
            height: auto;
            min-height: 38px;
            padding: 0.5rem 0;
        }
        
        .select2-container--default .select2-selection--single:focus,
        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--open .select2-selection--single {
            border-bottom-color: #60a5fa;
            outline: none;
            box-shadow: none;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #6b7280;
            padding-left: 0;
            padding-right: 20px;
            font-size: 1rem;
            letter-spacing: 0.05em;
            line-height: 1.5;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: #9ca3af;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100%;
            right: 0;
        }
        
        .select2-container--default .select2-selection--single .select2-selection__clear {
            margin-right: 20px;
            font-size: 1.2em;
        }
        
        .select2-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #60a5fa;
        }
        
        .select2-search--dropdown .select2-search__field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        
        .select2-search--dropdown .select2-search__field:focus {
            border-color: #60a5fa;
            outline: none;
        }
        
        /* Styles pour les checkboxes */
        #id_use_existing_father,
        #id_use_existing_mother,
        #id_have_parents {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
    </style>

  <form action="{% url 'civil:birth-save' %}" method="post" class="flex flex-col gap-y-8">
  {% csrf_token %}
  
  {% for title, fields in form.fieldsets_fields.items %}
    {% if title == matricule %}
      <fieldset class="flex justify-between gap-x-8 items-end 
                      max-sm:flex-wrap max-sm:flex-col-reverse max-sm:gap-y-4">
        {% for field in fields %}
          <div>{{ field }}</div>
        {% endfor %}
      </fieldset>

    {% else %}
      {# -- Si le champ est un dictionnaire (comme Informations about Parents) -- #}
      {% if fields.items %}
      <fieldset class="">
        <label for="id_have_parents" class="text-xl font-semibold text-gray-600">{{ title }}</label>
        {% if title == parents_information %}
          <input type="checkbox" name="do_certificate" id="id_have_parents"
                class="peer ml-2" checked title="{% translate 'Do a Certificate' %}">
        {% endif %}
        {% for sub_title, sub_fields in fields.items %}
          <fieldset class="grid  {% if title == parents_information %}hidden peer-checked:grid {% endif %}grid-cols-4 max-xl:grid-cols-3 max-lg:grid-cols-2 max-sm:grid-cols-1 gap-8 mb-5">
            <legend class="text-lg font-semibold text-gray-500 mb-2">{{ sub_title }}</legend>
                
              {% for field in sub_fields %}
                <div class="min-w-20 w-full {% if title == parents_information and sub_title != declarer %} parents_information{% if forloop.first %} col-span-full{% endif %}{% endif %}">
                  {{ field.label_tag }} {{ field }}
                </div>
              {% endfor %}
          </fieldset>
        {% endfor %}
      </fieldset>
        
      {# -- Sinon c’est une liste de champs simple -- #}
      {% else %}
        <fieldset class="grid grid-cols-5 max-2xl:grid-cols-4 
                          max-xl:grid-cols-3 max-lg:grid-cols-2 max-sm:grid-cols-1 
                          justify-evenly gap-x-8 gap-y-10 items-start">
          <legend class="text-xl font-semibold text-gray-600 mb-4">{{ title }}</legend>
          
          {% for field in fields %}
            <div class="min-w-20 w-full">
              {{ field.label_tag }} {{ field }}
            </div>
          {% endfor %}
        </fieldset>
      {% endif %}
    {% endif %}
  {% endfor %}
  
  <div class="flex justify-end gap-8 text-white">
    <input type="submit" value="{% trans 'Submit' %}" class="bg-primary px-4 py-3 rounded-lg w-32 cursor-pointer hover:bg-blue-500">
    <input type="reset" value="{% trans 'Reset' %}" class="bg-secondary px-4 py-3 rounded-lg w-32 cursor-pointer hover:bg-gray-500">
  </div>
</form>

  <script>
    $(document).ready(function() {
        // Configuration de base des selects Select2
        $('.select2').select2({
            width: '100%'
        });

        // Gestion de l'affichage conditionnel pour les informations des parents
        function toggleFamilyFields(){
          if($('#id_have_parents').is(':checked')){
            $('#id_use_existing_father').prop('checked', true);
            $('#id_use_existing_mother').prop('checked', true);
          } else {
            $('#id_use_existing_father').prop('checked', false);
            $('#id_use_existing_mother').prop('checked', false).prop('required', false);
          }
          toggleFatherFields();
          toggleMotherFields();
          toggleDeclarerFields();
        }
        
        // Gestion de l'affichage conditionnel pour le père
        function toggleFatherFields() {

          const isChecked = $('#id_use_existing_father').is(':checked');

          if (isChecked) {
              // Afficher l'autocomplete
              $('[aria-controls="select2-id_existing_father-results"], [name="existing_father"], [name="father_name"], [name="father_place_of_birth"], [name="father_birthday"], [name="father_job"], [name="father_address"]').closest('.parents_information').show();
              // Mettre les autres champs en lecture seule
              $('[name="father_name"], [name="father_place_of_birth"], [name="father_birthday"]')
                  .prop('readonly', true)
                  .addClass('bg-gray-100 cursor-not-allowed');
              $('[name="father_job"], [name="father_address"]').prop("required", true);
          } else {
              // Cacher l'autocomplete
              $('[aria-controls="select2-id_existing_father-results"], [name="existing_father"], [name="father_name"], [name="father_place_of_birth"], [name="father_birthday"], [name="father_job"], [name="father_address"]').closest('.parents_information').hide();
              // Tous les champs deviennent éditables
              $('[name="father_name"], [name="father_place_of_birth"], [name="father_birthday"], [name="father_job"], [name="father_address"]')
                  .prop('readonly', false)
                  .removeClass('bg-gray-100 cursor-not-allowed')
                  .prop("required", false);
          }
        }
        
        // Gestion de l'affichage conditionnel pour la mère
        function toggleMotherFields() {

          const isChecked = $('#id_use_existing_mother').is(':checked');
            
            if (isChecked) {
                // Afficher l'autocomplete
                $('[aria-controls="select2-id_existing_mother-results"], [name="existing_mother"], [name="mother_name"], [name="mother_place_of_birth"], [name="mother_birthday"], [name="mother_job"], [name="mother_address"]').closest('.parents_information').show();
                // Garder les autres champs visibles mais en lecture seule
                $('[name="mother_name"], [name="mother_place_of_birth"], [name="mother_birthday"]')
                    .prop('readonly', true)
                    .addClass('bg-gray-100 cursor-not-allowed');
                $('[name="mother_job"], [name="mother_address"]').prop("required", true);
            } else {
                // Cacher l'autocomplete
                $('[aria-controls="select2-id_existing_mother-results"],[name="existing_mother"], [name="mother_name"], [name="mother_place_of_birth"], [name="mother_birthday"], [name="mother_job"], [name="mother_address"]').closest('.parents_information').hide();
                // Tous les champs deviennent éditables
                $('[name="mother_name"], [name="mother_place_of_birth"], [name="mother_birthday"], [name="mother_job"], [name="mother_address"]')
                    .prop('readonly', false)
                    .removeClass('bg-gray-100 cursor-not-allowed')
                    .prop("required", false);
            }
        }

        // Gestion de l'affichage conditionnel pour le déclarant
        function toggleDeclarerFields() {

          const isChecked = $('#id_have_parents').is(':checked');
            
            if (isChecked) {
                // Afficher l'autocomplete
                $('[aria-controls="select2-id_existing_declarer-results"], [name="existing_declarer"], [name="declarer_name"], [name="declarer_place_of_birth"], [name="declarer_birthday"], [name="declarer_job"], [name="declarer_address"]').closest('.parents_information').show();
                // Garder les autres champs visibles mais en lecture seule
                $('[name="declarer_name"], [name="declarer_place_of_birth"], [name="declarer_birthday"]')
                    .prop('readonly', true)
                    .addClass('bg-gray-100 cursor-not-allowed');
                $('[name="declarer_job"], [name="declarer_address"]').prop("required", true);
            } else {
                // Cacher l'autocomplete
                $('[aria-controls="select2-id_existing_declarer-results"], [name="existing_declarer"], [name="declarer_name"], [name="declarer_place_of_birth"], [name="declarer_birthday"], [name="declarer_job"], [name="declarer_address"]').closest('.parents_information').hide();
                // Tous les champs deviennent éditables
                $('[name="declarer_name"], [name="declarer_place_of_birth"], [name="declarer_birthday"], [name="declarer_job"], [name="declarer_address"]')
                    .prop('readonly', false)
                    .removeClass('bg-gray-100 cursor-not-allowed')
                    .prop("required", false);
            }
        }
        
        // Écouter les changements sur les checkboxes
        $('#id_have_parents').on('change', toggleFamilyFields);
        $('#id_use_existing_father').on('change', toggleFatherFields);
        $('#id_use_existing_mother').on('change', toggleMotherFields);
        
        // Initialiser l'état au chargement
        toggleFatherFields();
        toggleMotherFields();
        toggleDeclarerFields();
        
        // Auto-remplissage quand un père existant est sélectionné
        $('#id_existing_father').on('select2:select', function(e) {
            const personId = e.params.data.id;
            
            // Requête AJAX pour récupérer les détails du père
            $.ajax({
                url: "{% url 'civil:person-details' 0 %}".replace('0', personId),  // Ajustez l'URL selon votre configuration
                method: 'GET',
                success: function(data) {
                    // Remplir les champs du père
                    $('[name="father_name"]').val(data.full_name);
                    $('[name="father_place_of_birth"]').val(data.birth_place);
                    $('[name="father_birthday"]').val(data.birthday);
                    
                    console.log('✅ Informations du père chargées avec succès');
                },
                error: function(xhr, status, error) {
                    console.error('❌ Erreur lors du chargement des informations du père:', error);
                    alert('Erreur lors du chargement des informations du père');
                }
            });
        });
        
        // Auto-remplissage quand une mère existante est sélectionnée
        $('#id_existing_mother').on('select2:select', function(e) {
            const personId = e.params.data.id;
            
            // Requête AJAX pour récupérer les détails de la mère
            $.ajax({
                url: "{% url 'civil:person-details' 0 %}".replace('0', personId),  // Ajustez l'URL selon votre configuration
                method: 'GET',
                success: function(data) {
                    // Remplir les champs de la mère
                    $('[name="mother_name"]').val(data.full_name);
                    $('[name="mother_place_of_birth"]').val(data.birth_place);
                    $('[name="mother_birthday"]').val(data.birthday);
                    
                    console.log('✅ Informations de la mère chargées avec succès');
                },
                error: function(xhr, status, error) {
                    console.error('❌ Erreur lors du chargement des informations de la mère:', error);
                    alert('Erreur lors du chargement des informations de la mère');
                }
            });
        });

        // Auto-remplissage quand un déclarant existant est sélectionné
        $('[name="existing_declarer"]').on('select2:select', function(e) {
            const personId = e.params.data.id;
            
            // Requête AJAX pour récupérer les détails de la mère
            $.ajax({
                url: "{% url 'civil:person-details' 0 %}".replace('0', personId),  // Ajustez l'URL selon votre configuration
                method: 'GET',
                success: function(data) {
                    // Remplir les champs de la mère
                    $('[name="declarer_name"]').val(data.full_name);
                    $('[name="declarer_place_of_birth"]').val(data.birth_place);
                    $('[name="declarer_birthday"]').val(data.birthday);
                    
                    console.log('✅ Informations du déclarant chargées avec succès');
                },
                error: function(xhr, status, error) {
                    console.error('❌ Erreur lors du chargement des informations du déclarant:', error);
                    alert('Erreur lors du chargement des informations du déclarant');
                }
            });
        });
        
        // Réinitialiser les champs quand on déselectionne
        $('#id_existing_father').on('select2:unselect', function(e) {
            $('[name="father_name"], [name="father_place_of_birth"], [name="father_birthday"], [name="father_job"], [name="father_address"]').val('');
        });
        
        $('#id_existing_mother').on('select2:unselect', function(e) {
            $('[name="mother_name"], [name="mother_place_of_birth"], [name="mother_birthday"], [name="mother_job"], [name="mother_address"]').val('');
        });

        $('[name="existing_declarer"]').on('select2:unselect', function(e) {
            $('[name="declarer_name"], [name="declarer_place_of_birth"], [name="declarer_birthday"], [name="declarer_job"], [name="declarer_address"]').val('');
        });
        
        // Gestion du bouton Reset
        $('input[type="reset"]').on('click', function() {
            setTimeout(function() {
                // Réinitialiser les Select2
                $('.select2').val(null).trigger('change');
                // Réinitialiser l'état des checkboxes et des champs
                toggleFatherFields();
                toggleMotherFields();
                toggleDeclarerFields();
            }, 10);
        });
    });
    </script>

{% endblock action %}
