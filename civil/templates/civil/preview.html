{% extends "base.html" %}
{% block article %}
{% load isa_gasy %}
{% load static %}
{% load i18n %}
    
    <style>
        .zoom-container {
            transform-origin: top center;
            transition: transform 0.2s ease;
        }
        @media print {
            body * {
                visibility: hidden !important;
            }
            #print-area, #print-area * {
                visibility: visible !important;
            }

            #print-area {
                position: absolute !important;
                left: 0;
                top: 0;
                width: 100%;
            }

            .zoom-container {
                transform: none !important;
            }

            .a4-page {
                margin: 0 !important;
                box-shadow: none;
                transform: none !important;
                width: 210mm !important;
                height: 297mm !important;
            }

        }
        
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 8mm 12mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 0px auto;
        }
        
        @page {
            size: A4;
            margin: 0;
        }
        
        .handwriting-title {
            font-family: 'Edwardian Script ITC', cursive;
            font-size: 36pt;
            font-weight: 600;
            text-align: center;
        }
        
        .stamp {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 3px solid rgba(220, 38, 38, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-15deg);
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 6rem;
            color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
        }
    </style>
    
    <!-- Barre d'actions (non imprimable) -->
    <div class="no-print bg-white border-b shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        {% trans "Certificate Preview" %}
                    </h1>
                    <p class="text-sm text-gray-600">
                        {{ document_info.get_document_type_display }} - {{ document_info.document_number }}
                        <span class="ml-2 px-2 py-1 text-xs rounded-full
                            {% if document_info.status == 'VALIDATED' %}bg-green-100 text-green-800
                            {% elif document_info.status == 'DRAFT' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-red-100 text-red-800{% endif %}">
                            {{ document_info.get_status_display }}
                        </span>
                    </p>
                </div>
                
                <div class="flex gap-3">
                    <!-- Bouton Zoom -->
                    <div class="flex items-center gap-2 no-print">
                        <button onclick="zoomOut()" class="bg-gray-200 px-3 py-1 rounded">−</button>
                        <span onclick="zoomAjust()" id="zoom-level" class="text-sm font-semibold w-10 text-center cursor-pointer">100%</span>
                        <button onclick="zoomIn()" class="bg-gray-200 px-3 py-1 rounded">+</button>
                    </div>
                    <!-- Bouton Imprimer -->
                    <button onclick="window.print()" 
                        class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        {% trans "Print" %}
                    </button>
                    
                    <!-- Bouton Modifier -->
                    {% if document_info.can_edit %}
                    <a href="" 
                        class="flex items-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        {% trans "Edit" %}
                    </a>
                    {% endif %}
                    
                    <!-- Bouton Supprimer -->
                    {% if document_info.can_delete %}
                    <button onclick="confirmDelete()" 
                        class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        {% trans "Delete" %}
                    </button>
                    {% endif %}
                    
                    <!-- Bouton Retour -->
                    <button onclick="back_or_list()"
                        class="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        {% trans "Back" %}
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Document A4 -->
   <div class="zoom-container">
        {% language 'mg' %}
        <div class="flex flex-col" id="print-area">
            {% for document in document_group %}
            <div class="a4-page flex flex-col items-end text-[12pt] font-['Times_New_Roman']">
                {% comment %} <!-- Watermark -->
                {% if document.status == 'DRAFT' %}
                <div class="watermark">BROUILLON</div>
                {% endif %} {% endcomment %}
                    
                <!-- Note en haut à droite (filigrane) -->
                <div class="font-sans text-[8pt] text-gray-500 ring-1 ring-black pt-1 pr-14 pb-4 pl-2 max-w-xs bg-white">
                    Teny midina laharana faha: 788-MJ/CAB<br>
                    tamin'ny 29 desambra 1961 nataon'ny<br>
                    <span class="pl-8">Minisitry ny Fitsiavana</span><br>
                    sy Mpitahiry ny Kasem-panjakana
                </div>
                
                <div class="grid  grid-cols-10 mt-[8px] gap-y-8 gap-x-4">
                    <!-- Informations administratives -->
                    <div class="flex text-[11pt] col-span-3 flex-col items-start mt-[138px] gap-y-2 leading-tight">
                        <p class="indent-8 underline">N° {{ document.pk }}/</p>
                        <p class="indent-3">{{ document.birth_certificate.date_created|date:"d" }} {{ document.birth_certificate.date_created|date:"m"|volana_gasy|capfirst }} {{ document.birth_certificate.date_created|date:"Y" }}</p>
                        <p class="indent-1 uppercase">
                            {% if document.birth_certificate.certificate_type == "R" %}
                                FAHATERAHANA SY<br>FANJANAHANA
                            {% else %}
                                FAHATERAHANA
                            {% endif %}
                        </p>
                        <p class="">{{ document.birth_certificate.born.full_name }}</p>
                        <p class="indent-8">{{ document.birth_certificate.born.birthday|date:"d-m-y" }}</p>
                        <p class="font-semibold indent-7 tracking-widest">---------------</p>
                    </div>
                    
                    <!-- Corps du texte en malgache -->
                    <div class="flex flex-col col-span-7 gap-y-10 leading-tight text-justify" style="position: relative; z-index: 1;">
                        
                        <!-- Titre en écriture manuscrite -->
                        <div class="">
                            <h1 class="handwriting-title
                            relative inline-block
                            after:content-[''] after:absolute
                            after:border-b-2 after:border-dashed after:border-black
                            after:left-0 after:w-full after:h-[2px]
                            after:bottom-[0.2em]">Kopian'ny Sora-piankohonana</h1>
                        </div>

                        <div class="relative 
                            after:content-[''] after:absolute
                            after:bg-white
                            after:left-0 after:w-full after:h-[20px]"
                        >
                            <p class="inline text-justify bg-clip-text">
                                _______Nalaina tamin'ny bokim-piankohonana ao {{ document.birth_certificate.fokotany.name }}, taona {{ document.birth_certificate.date_created|date:"Y" }},
                                izao soratra manaraka izao.
                            </p>
                            <p class="inline">-------------------------------------------------------------------------------------------</p>
                        </div>

                        <div class="relative 
                            after:content-[''] after:absolute
                            after:bg-white
                            after:left-0 after:w-full after:h-[20px]"
                        >
                            <p class="inline text-justify">
                                _________Tamin'ny {{ document.birth_certificate.born.birthday|date:"d"|isa_gasy }} {{ document.birth_certificate.born.birthday|date:"m"|volana_gasy|capfirst }}, taona {{ document.birth_certificate.born.birthday|date:"Y"|isa_gasy }}, tamin'ny {{ document.birth_certificate.born.birthday|date:"h"|isa_gasy }} ora {{ document.birth_certificate.born.birthday|date:"h"|ora_gasy }}, no {% if document.birth_certificate.born.is_alive %}teraka {% else %}maty teo ampiterahana {% endif %}tao amin'ny {{ document.birth_certificate.born.birth_place }}, 
                                Commune {% if common_name|lower in document.birth_certificate.born.birth_place|lower %} io ihany{% else %} {{ common_name }}{% endif %}: 
                                {{ document.birth_certificate.born.full_name }}, {% if document.birth_certificate.born.gender == 'M' %}zanakalahy{% else %}zanakavavy{% endif %}, zanak'i 
                                {% if document.birth_certificate.father %}{{ document.birth_certificate.father.full_name }} teraka tamin'ny {{ document.birth_certificate.father.birthday|date:"d"|isa_gasy }} {{ document.birth_certificate.father.birthday|date:"m"|volana_gasy|capfirst }}, taona {{ document.birth_certificate.father.birthday|date:"Y"|isa_gasy }}, tao {{ document.birth_certificate.father.birth_place }},{% if document.birth_certificate.father_carreer|lower != document.birth_certificate.mother_carreer|lower %} {{document.birth_certificate.father_carreer|lower}}, {% endif %}{% if document.birth_certificate.father_address != document.birth_certificate.mother_address %} monina ao {{document.birth_certificate.father_address}} {% endif %}
                                {% if document.birth_certificate.certificate_type == 'R' %}izay nanjana'azy teo amin'ny fahaterahany {% endif %} sy {% endif %}
                                {{ document.birth_certificate.mother.full_name }}, teraka tamin'ny {{ document.birth_certificate.mother.birthday|date:"d"|isa_gasy }} {{ document.birth_certificate.mother.birthday|date:"m"|volana_gasy|capfirst }}, taona {{ document.birth_certificate.mother.birthday|date:"Y"|isa_gasy }}, tao {{ document.birth_certificate.mother.birth_place }}{% if document.birth_certificate.father_carreer|lower != document.birth_certificate.mother_carreer|lower %}, {{document.birth_certificate.mother_carreer|lower}}, {% endif %}{% if document.birth_certificate.father_address != document.birth_certificate.mother_address %} monina ao {{document.birth_certificate.mother_address}} {% endif %}
                                {% if document.birth_certificate.father_carreer|lower == document.birth_certificate.mother_carreer|lower and document.birth_certificate.father_address == document.birth_certificate.mother_address %}, samy {{document.birth_certificate.mother_carreer|lower}} sy monina ao {{document.birth_certificate.mother_address}}{% if not '-' in document.birth_certificate.mother_address %}, Commune ao {{ document.birth_certificate.fokotany.name }}{% endif %}
                                {% elif document.birth_certificate.father_carreer|lower|lower == document.birth_certificate.mother_carreer|lower|lower %}, samy {{document.birth_certificate.mother_carreer|lower|lower}}
                                {% elif document.birth_certificate.father_address == document.birth_certificate.mother_address %}, samy monina ao {{document.birth_certificate.mother_address}}{% if not '-' in document.birth_certificate.mother_address %}, Commune ao {{ document.birth_certificate.fokotany.name }}{% endif %}{% endif %}.
                            </p>
                            <p class="inline">-------------------------------------------------------------------------------------------</p>
                        </div>

                        <div class="relative 
                            after:content-[''] after:absolute
                            after:bg-white
                            after:left-0 after:w-full after:h-[20px]"
                        >
                            <p class="inline text-justify">
                                _________Nosoratana androany {{ document.birth_certificate.date_created|date:"d"|isa_gasy }} {{ document.birth_certificate.date_created|date:"m"|volana_gasy|capfirst }}, taona {{ document.birth_certificate.date_created|date:"Y"|isa_gasy }},
                                tamin'ny {{ document.birth_certificate.date_created|date:"h"|isa_gasy }} ora {{ document.birth_certificate.date_created|date:"h"|ora_gasy }}, araky ny fanambarana nataon'i
                                {% if document.birth_certificate.declarer == document.birth_certificate.father %} rainy izay {% elif document.birth_certificate.declarer == document.birth_certificate.mother %} reniny izay {% else %}{{ document.birth_certificate.declarer.full_name }},
                                teraka tamin'ny {{ document.birth_certificate.declarer.birthday|date:"d"|isa_gasy }} {{ document.birth_certificate.declarer.birthday|date:"F"|capfirst }}, taona {{ document.birth_certificate.declarer.birthday|date:"Y"|isa_gasy }}, 
                                tao {{ document.birth_certificate.declarer.birth_place }}, {{ document.birth_certificate.declarer_carreer|lower }}, monina ao {{ document.birth_certificate.declarer_address }},
                                izay nanatrika ny fahaterahany ka {% endif %} miara manao Sonia aminay:
                                {{ document.birth_certificate.responsible_staff }} mpiandraikitra sora-piankohonana ao {{ document.birth_certificate.fokotany.name }}, rehefa novakina taminy ity soratra ity.
                            </p>
                            <p class="inline">-------------------------------------------------------------------------------------------</p>
                        </div>
                    </div>
                    
                    <p class="col-span-3 text-[11pt] underline mt-4 indent-4">SARANY : 1000 Ariary</p>

                    <div class="col-span-7 space-y-1 leading-relaxed text-justify" style="position: relative; z-index: 1;">
                        <p class="indent-20">= MANARAKA NY SONIA =</p>
                        <div class="pl-32">
                            <p class="indent-10"> = </p>
                            <p class="indent-16"> = </p>
                            <p class="indent-24"> = </p>
                        </div>
                        
                        <div class="flex justify-between items-end mt-12">                        
                            <div class="flex flex-col gap-8">
                                <p class="indent-8 leading-tight">Kopia manontolo nadika tamin'ny boky androany 
                                    {{ document.created_at|date:"d" }} {{ document.created_at|date:"m"|volana_gasy|capfirst }} {{ document.created_at|date:"Y" }}.</p>
                                
                                <p class="font-bold uppercase mb-2 text-center">NY MPIANDRAIKITRA SORA-PIANKOHONANA</p>
                                
                                {% comment %} {% if document.validated_by %}
                                <div class="relative inline-block">
                                    <p class="font-bold text-blue-800" style="transform: rotate(-5deg);">
                                        {{ document.validated_by }}
                                    </p>
                                </div>
                                {% else %}
                                <div class="h-16 border-b-2 border-gray-400 w-48 ml-auto"></div>
                                {% endif %} {% endcomment %}
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            {% endfor %}
        </div>
        {% endlanguage %}
    </div>
    <!-- Pied de page -->
    <div class="absolute no-print bottom-8 left-0 right-0 text-center text-xs text-gray-500">
        <p>{% trans "Issued on" %} {{ document_info.created_at|date:"d/m/Y" }} - 
           {% trans "Document" %} #{{ document_info.document_number }}</p>
    </div>
    
    <script>
        let zoom = 1.0; // 100%

        function updateZoom() {
            document.querySelector('.zoom-container').style.transform = `scale(${zoom})`;
            document.getElementById('zoom-level').textContent = `${Math.round(zoom * 100)}%`;
        }

        function zoomIn() {
            if (zoom < 2.0) { // max 200%
                zoom += 0.1;
                updateZoom();
            }
        }

        function zoomAjust() {
            zoom = 1;
            updateZoom();
        }

        function zoomOut() {
            if (zoom > 0.5) { // min 50%
                zoom -= 0.1;
                updateZoom();
            }
        }
        function confirmDelete() {
            if (confirm('{% trans "Are you sure you want to delete this certificate?" %}')) {
                window.location.href = "";
            }
        }

        function back_or_list(){
            if(document.referrer !== ""){
                history.back()
            } else {
                window.location.href = "{% url 'civil:birth' %}"
            }
        }
    </script>
{% endblock article %}
