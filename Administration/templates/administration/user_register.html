{% extends "action_base.html" %}
{% block action %}
{% load i18n %}
{% translate "Other Informations" as parents_information %}
{% translate 'Matricule' as matricule %}
{% translate 'Applications' as app %}

  <style>
    div > label {
      font-weight: 600;
      font-family: sans-serif;
    }
  </style>

  <form action="{% url save_url %}" method="post" class="flex flex-col gap-y-8">
  {% csrf_token %}
  
  {% for title, fields in form.fieldsets_fields.items %}
    {% if title == matricule %}
      <fieldset class="flex justify-end gap-x-8 items-end 
                      max-sm:flex-wrap max-sm:flex-col-reverse max-sm:gap-y-4">
        {% for field in fields %}
          <div>{{ field }}</div>
        {% endfor %}
      </fieldset>
    {% else %}
      {# -- Si le champ est un dictionnaire (comme Informations about Parents) -- #}
      {% if fields.items %}
      <fieldset class="">
        <label for="id_have_parents" class="text-xl font-semibold text-sky-900">{{ title }}</label>
        {% if title == parents_information %}
          <input type="checkbox" name="do_certificate" id="id_have_parents"
                class="peer ml-2" checked title="{% translate 'Do a Certificate' %}">
        {% endif %}
        {% for sub_title, sub_fields in fields.items %}
          <fieldset class="grid  {% if title == parents_information %}hidden peer-checked:grid {% endif %}grid-cols-4 max-xl:grid-cols-3 max-lg:grid-cols-2 max-sm:grid-cols-1 gap-8 mb-5">
            <legend class="text-lg font-semibold text-gray-500 mb-2">{{ sub_title }}</legend>
                
              {% for field in sub_fields %}
                <div class="min-w-20 w-full {% if title == parents_information and sub_title != 'Declarer' %} parents_information{% if forloop.first %} col-span-full{% endif %}{% endif %}">
                  {{ field.label_tag }} {{ field }}
                </div>
              {% endfor %}
          </fieldset>
        {% endfor %}
      </fieldset>
        
      {# -- Sinon c’est une liste de champs simple -- #}
      {% else %}
        <fieldset class="grid grid-cols-5 max-2xl:grid-cols-4 
                          max-xl:grid-cols-3 max-lg:grid-cols-2 max-sm:grid-cols-1 
                          justify-evenly gap-x-8 gap-y-10 items-start">
          <legend class="text-xl font-semibold text-sky-900 mb-4">{{ title }}</legend>
          
          {% for field in fields %}
            <div class="min-w-20 w-full items-center">
              {% if title == app %}
                {{ field }} {{ field.label_tag }}
              {% else %}
                {{ field.label_tag }} {{ field }}
              {% endif %}
            </div>
          {% endfor %}
        </fieldset>
      {% endif %}
    {% endif %}
  {% endfor %}
  
  <div class="flex justify-end gap-8 text-white">
    <input type="submit" value="{% trans 'Submit' %}" class="bg-primary px-4 py-3 rounded-lg w-32 cursor-pointer hover:bg-blue-500">
    <input type="reset" value="{% trans 'Reset' %}" class="bg-secondary px-4 py-3 rounded-lg w-32 cursor-pointer hover:bg-gray-500">
  </div>
</form>

<script>
  $(document).ready(function() {
        
        var is_out = true;
        const menu_name = '{{ menu_name|safe }}';

        function searchPerson(e){
          var search_container = $(e.target).next().children('[data-id="id-results-container"]');
          console.log(search_container);
          search_container.empty();

          if(String($(e.target).val()).length >= 2){
            console.log(String($(e.target)).length);
            console.log($(e.target).attr('data-gender'));

            // Requête AJAX pour faire une recherche
            $.ajax({
                url: "{% url 'administration:search-staff' 0 %}".replace('0', $(e.target).val()),  // Ajustez l'URL selon votre configuration
                method: 'GET',
                success: function(data) {
                    // Remplir les champs du père
                    data.staff_list.forEach(staff_id => {
                      console.log(staff_id);
                      search_container.append('<button type="button" name="result-btn" data-value="'+ staff_id +'" title="'+ data.staff_name[staff_id] +'" class="contain-content p-4 shadow-sm rounded-md cursor-pointer w-full text-nowrap text-ellipsis text-left hover:bg-blue-100">'+ data.staff_name[staff_id] +'<button>')
                        
                    });

                    var val_actu = $(e.target).val();

                    search_container.children('button').on('mouseenter', (i)=>{
                      is_out = false;
                      console.log('HOVER')
                      $(e.target).val('');
                      $(e.target).val($(i.target).text());
                    });

                    search_container.on('mouseleave', (i)=>{
                      console.log('OUTTTTTTTTTTTTT');
                      is_out = true;
                      $(e.target).val(val_actu);
                    });

                    search_container.children('button').on('click', (i)=>{
                      console.log($(i.target))
                      console.log($(i.target).attr('data-value'))
          
                      // Requête AJAX pour récupérer les détails du père
                      $.ajax({
                          url: "{% url 'administration:staff-details' 0 %}".replace('0', $(i.target).attr('data-value')),  // Ajustez l'URL selon votre configuration
                          method: 'GET',
                          success: function(data) {
                            console.log(data);
                            
                            $(e.target).parents('fieldset').children('div').each((index, element)=>{
                              var autocomplete_field = $(element);
                              if (!autocomplete_field.children().is("input, select")){
                                autocomplete_field = $(element).children('div');
                              }

                              console.log(autocomplete_field);

                              if (autocomplete_field.children("input, select").attr('id').search("last_name") != -1){
                                autocomplete_field.children("input, select").val(data.last_name);
                              }
                              else if (autocomplete_field.children("input, select").attr('id').search("first_name") != -1){
                                autocomplete_field.children("input, select").val(data.first_name);
                              }
                              else if (autocomplete_field.children("input, select").attr('id').search("gender") != -1){
                                autocomplete_field.children("input, select").val(data.gender);
                              }
                              else if (autocomplete_field.children("input, select").attr('id').search("birthday") != -1){
                                autocomplete_field.children("input, select").val(data.birthday);
                              } else {
                                console.log('Cette donnée n\'a pas de champ !!!');
                              }
                            });
                            
                            console.log('✅ Informations du père chargées avec succès');
                          },
                          error: function(xhr, status, error) {
                              console.error('❌ Erreur lors du chargement des informations du père:', error);
                              alert('Erreur lors du chargement des informations du père');
                          }
                      });
                      
                      search_container.parent().remove();
                      searched_staff = $('.searched_staff');
                      is_out = true;
                    });
                    
                    console.log('✅ Informations du père chargées avec succès');
                },
                error: function(xhr, status, error) {
                    console.error('❌ Erreur lors du chargement des informations du père:', error);
                    // alert('Erreur lors du chargement des informations du père');
                      $('[data-id="id-results-container"]').replaceAll('<p>Aucune personne trouvée</p>');
                }
            });
          } else {
            search_container.append(
                "<p>En attente d\'au moins 2 caractères...</p>"
            );
          }
        }

        var searched_staff = $('.searched_staff');

        searched_staff.on('focus', (e)=>{
          searched_staff = $(e.target);
          // $('main').scroll((i)=>{
          //   e.target.scrollIntoView(true);

          // });
          
          if($(e.target).next().length === 0) {
            $(e.target.parentElement).append(
              '<div data-id="id-results" class="w-full max-h-0">\
                <div data-id="id-results-container" class="sticky max-h-48 w-full overflow-y-auto bg-white shadow-md rounded-b-lg p-2">\
                  <div><p>En attente d\'au moins 2 caractères...</p></div>\
                </div>\
              </div>'
            );
          }
          searchPerson(e);
        });
        
        searched_staff.on('input', (e)=>{
          searchPerson(e);
        });

        searched_staff.on('focusout', (e)=>{
          if (is_out){
            $(e.target).next().remove();
            searched_staff = $('.searched_staff');
          }
        });
});
</script>

{% endblock action %}
